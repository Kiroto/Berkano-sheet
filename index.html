<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Document</title>
    <link rel="stylesheet" href="style.css" />
  </head>
  <body>
    <div class="header-container">
      <div class="stat-container">
        <label for="archetype-select">Arquetipo</label>
        <select id="archetype-select"></select>
        <label for="str-bar">Fuerza</label>
        <div>
          <progress
            class="str-progress"
            id="str-bar"
            value="0"
            max="20"
          ></progress>
          <input id="str-input" type="number" min="0" max="20" value="0" />
        </div>
        <label for="dex-bar">Destreza</label>
        <div>
          <progress
            class="dex-progress"
            id="dex-bar"
            value="0"
            max="20"
          ></progress>
          <input id="dex-input" type="number" min="0" max="20" value="0" />
        </div>
        <label for="wis-bar">Sabidur√≠a</label>
        <div>
          <progress
            class="wis-progress"
            id="wis-bar"
            value="0"
            max="20"
          ></progress>
          <input id="wis-input" type="number" min="0" max="20" value="0" />
        </div>
        <label for="int-bar">Inteligencia</label>
        <div>
          <progress
            class="int-progress"
            id="int-bar"
            value="0"
            max="20"
          ></progress>
          <input id="int-input" type="number" min="0" max="20" value="0" />
        </div>
        <label for="cha-bar">Carisma</label>
        <div>
          <progress
            class="cha-progress"
            id="cha-bar"
            value="0"
            max="20"
          ></progress>
          <input id="cha-input" type="number" min="0" max="20" value="0" />
        </div>
      </div>
      <div class="stat-container">
        <label for="name-input">Nombre</label>
        <input id="name-input" type="text" />
        <label for="health-input">Vida (Actual/MaximaActual/MaximaBase)</label>

        <progress id="health-progress" min="0" max="50" value="50"></progress>

        <div class="horizontal-flex">
          <input id="health-input" type="number" value="50" />
          /
          <input id="health-current-max" type="number" value="50" />
          /
          <input id="health-max" type="number" value="50" readonly />
        </div>
        <label for="movement-input">Movimiento</label>
        <input id="movement-input" type="text" readonly />
        <label for="compatibilities-input">Compatibilidades</label>
        <input id="compatibilities-input" type="text" readonly />
        <label for="incompatibilities-input">Incompatibilidades</label>
        <input id="incompatibilities-input" type="text" readonly />
      </div>
      <div id="ultimate-field" class="ultimate-text-area-container">
        <h2>Definitiva</h2>
        <textarea id="ultimate-text-area"> </textarea>
      </div>
    </div>

    <div class="action-list-container">
      <div class="action-list">
        <h2>Acciones Primarias</h2>
        <ul id="primary-actions" class="actions-list"></ul>
      </div>
      <div class="action-list">
        <h2>Acciones Secundarias</h2>
        <ul id="secondary-actions" class="actions-list"></ul>
      </div>
      <div class="action-list">
        <h2>Reacciones Aliadas</h2>
        <ul id="ally-reactions" class="actions-list"></ul>
      </div>
      <div class="action-list">
        <h2>Reacciones Enemigas</h2>
        <ul id="enemy-reactions" class="actions-list"></ul>
      </div>
    </div>
  </body>
  <script>
    const defaultActionSource = {
      primaryActions: [],
      secondaryActions: [],
      allyReactions: [],
      enemyReactions: []
    }

    const defaultArchetypeSource = []
    const archetypeSource = []
    archetypeSource.push(...defaultArchetypeSource)
    const actionSource = Object.assign({}, defaultActionSource)

    const DOMPAList = document.getElementById('primary-actions')
    const DOMSAList = document.getElementById('secondary-actions')
    const DOMARList = document.getElementById('ally-reactions')
    const DOMERList = document.getElementById('enemy-reactions')

    const DOMUltimateField = document.getElementById('ultimate-field')
    const DOMArchetypeSelect = document.getElementById('archetype-select')

    const DOMHealthBar = document.getElementById('health-progress')
    const DOMHealthCurrent = document.getElementById('health-input')
    const DOMHealthCurrentMax = document.getElementById('health-current-max')
    const DOMMaxHealth = document.getElementById('health-max')
    const DOMMovement = document.getElementById('movement-input')
    const DOMCompat = document.getElementById('compatibilities-input')
    const DOMIncompat = document.getElementById('incompatibilities-input')

    const genStatPair = statName => {
      return {
        stat: statName,
        bar: document.getElementById(statName + '-bar'),
        input: document.getElementById(statName + '-input')
      }
    }

    const stats = ['str', 'int', 'wis', 'dex', 'cha']

    const statDomData = stats.map(it => genStatPair(it))

    const getCurrentArchKey = () => {
      return DOMArchetypeSelect.value
    }

    const getCurrentArch = () => {
      return archetypeSource.find(it => it['key'] == getCurrentArchKey())
    }

    const getCurrentArchStat = () => {
      const arch = getCurrentArch()
      if (arch) {
        return arch['mainStat']
      }
      return undefined
    }

    const refreshListPerThing = (domList, listSource, icon = undefined) => {
      domList.innerHTML = ''
      const currentArchStat = getCurrentArchStat()
      const currentArchKey = getCurrentArchKey()

      listSource.forEach(it => {
        const filterStatName = it['filter_stat']
        const filterReq = parseInt(it['filter_req'])
        const dataSource = statDomData.find(it => it.stat == filterStatName)
        const filterValue = parseInt(dataSource.input.value)
        const mainStatReq = it['filter_stat_req']
        const mainStatIsArch = filterStatName == currentArchStat
        const archReq = it['filter_archetype'] || []
        const fulfillsArchReq =
          archReq.length == 0 || archReq.includes(currentArchKey)

        if (
          filterValue >= filterReq &&
          (!mainStatReq || mainStatIsArch) &&
          fulfillsArchReq
        ) {
          const newAction = document.createElement('li')
          newAction.classList.add(filterStatName + '-action-item')
          newAction.classList.add('stat-action-item')
          if (it['title'] != undefined) {
            const titleSpan = document.createElement('span')
            titleSpan.classList.add('stat-action-item-title')
            titleSpan.innerText = (icon || '') + it['title']
            newAction.appendChild(titleSpan)
          }
          const contentDiv = document.createElement('div')
          contentDiv.innerText = it['text']
          newAction.appendChild(contentDiv)
          domList.appendChild(newAction)
        }
      })
    }

    const refreshActionsList = () => {
      const oldArchetype = getCurrentArchKey()
      DOMArchetypeSelect.innerHTML = ''
      archetypeSource.forEach(it => {
        const newArchetypeSelectOpt = document.createElement('option')
        newArchetypeSelectOpt.value = it['key']
        newArchetypeSelectOpt.text = it['name']
        DOMArchetypeSelect.appendChild(newArchetypeSelectOpt)
      })

      DOMArchetypeSelect.value = oldArchetype

      refreshListPerThing(DOMPAList, actionSource.primaryActions, 'üó°Ô∏è')
      refreshListPerThing(DOMSAList, actionSource.secondaryActions, 'üõ°Ô∏è')
      refreshListPerThing(DOMARList, actionSource.allyReactions, 'üëã')
      refreshListPerThing(DOMERList, actionSource.enemyReactions, '‚òùÔ∏è')

      DOMUltimateField.hidden = !statDomData.some(
        it => parseInt(it['input'].value) >= 20
      )
    }

    // Set up event listeners
    statDomData.forEach(statPair => {
      const refreshActionHandler = receiver => {
        const changeAmt = receiver.target.value
        if (!isNaN(changeAmt)) {
          statPair['bar'].value = changeAmt
        }

        refreshActionsList()
      }

      const archetypeSelectHandler = receiver => {
        const currentArch = getCurrentArch()
        DOMMaxHealth.value = currentArch.health
        DOMMovement.value = currentArch.speed
        DOMCompat.value = currentArch.compat.join(', ')
        DOMIncompat.value = currentArch.incompat.join(', ')
        refreshActionsList()
      }

      const updateHealthBar = receiver => {
        DOMHealthBar.max = DOMHealthCurrentMax.value
        DOMHealthBar.value = DOMHealthCurrent.value
      }
      statPair['input'].addEventListener('change', refreshActionHandler)
      DOMArchetypeSelect.addEventListener('change', archetypeSelectHandler)
      DOMHealthCurrent.addEventListener('change', updateHealthBar)
      DOMHealthCurrentMax.addEventListener('change', updateHealthBar)
    })

    // Set default values
    statDomData.forEach(statPair => {
      statPair['bar'].value = statPair['input'].value
    })

    // Load with preliminary data
    refreshActionsList()

    fetch('./source.json')
      .then(res => {
        if (!res.ok) {
          throw new Error(`HTTP error! Status: ${res.status}`)
        }
        return res.json()
      })
      .then(data => {
        actionSource.length = 0
        Object.assign(actionSource, data)
      })
      .catch(error => console.error('Unable to fetch data:', error))
      .finally(it => {
        refreshActionsList()
      })

    fetch('./archetypes.json')
      .then(res => {
        if (!res.ok) {
          throw new Error(`HTTP error! Status: ${res.status}`)
        }
        return res.json()
      })
      .then(data => {
        archetypeSource.length = 0
        Object.assign(archetypeSource, data)
      })
      .catch(error => console.error('Unable to fetch data:', error))
      .finally(it => {
        refreshActionsList()
      })
  </script>
</html>
